name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: "Skip pre-deploy tests"
        required: false
        default: "false"
        type: boolean

env:
  PROJECT_NAME: proxyfaqs
  PRODUCTION_URL: https://proxyfaqs.com

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.PRODUCTION_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        if: github.event.inputs.skip-tests != 'true'
        run: bun test || true

      - name: Build
        env:
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          SITE_URL: ${{ env.PRODUCTION_URL }}
        run: bun run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ env.PROJECT_NAME }} --commit-dirty=true

  verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for propagation
        run: sleep 30

      - name: Health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }})
          echo "Homepage: $STATUS"
          [ "$STATUS" -eq 200 ] || exit 1

      - name: API health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/api/health)
          echo "Health API: $STATUS"
          [ "$STATUS" -eq 200 ] || exit 1

      - name: SSR page check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.PRODUCTION_URL }}/q/am-i-using-a-vpn-or-proxy")
          echo "SSR page: $STATUS"
          [ "$STATUS" -eq 200 ] || echo "WARNING: SSR page returned $STATUS"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ env.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Deployed" >> $GITHUB_STEP_SUMMARY
