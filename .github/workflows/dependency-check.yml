name: Dependency Security Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
  pull_request:
    paths:
      - "package.json"
      - "bun.lock"
      - "front/package.json"
      - "front/bun.lock"

jobs:
  audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run npm audit
        run: |
          bun pm audit --audit-level moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: |
          bunx npm-check-updates --format group || true
        continue-on-error: true

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check licenses
        run: |
          # List all licenses
          bun pm ls | grep -E "GPL|AGPL|LGPL" && echo "WARNING: Copyleft licenses detected" || echo "No problematic licenses found"
        continue-on-error: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0

  update-summary:
    name: Create Summary
    runs-on: ubuntu-latest
    needs: [audit, license-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Dependency Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Audit | ${{ needs.audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
