name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  BUN_VERSION: "latest"

jobs:
  # Security scanning - runs first to fail fast on security issues
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Run security check script
        run: bash scripts/security-check.sh

      - name: Run npm audit
        run: bun pm audit --audit-level moderate
        continue-on-error: true

      - name: Check for sensitive files in git history
        run: |
          ! (git log --all --full-history -- '**/.env' '**/wrangler.toml' '**/*.pem' '**/*.key') | grep -q . || echo "WARNING: Sensitive files found in git history"

  # Linting and formatting
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check formatting with Prettier
        run: bun run format:check
        continue-on-error: true

      - name: Run ESLint
        run: bun run lint || true
        continue-on-error: true

      - name: TypeScript type checking
        run: bun run typecheck

  # Run tests
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun test

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            coverage/

  # Verify build succeeds
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        env:
          # Use placeholder values for CI build verification
          PUBLIC_SUPABASE_URL: https://example.supabase.co
          PUBLIC_SUPABASE_ANON_KEY: ci-placeholder-key
          SUPABASE_URL: https://example.supabase.co
          SUPABASE_SERVICE_KEY: ci-placeholder-key
          SITE_URL: https://proxyfaqs.com
          PUBLIC_SITE_URL: https://proxyfaqs.com
        run: bun run build

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not created"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "Build failed: index.html not found"
            exit 1
          fi
          echo "Build output verified successfully"

      - name: Check for critical pages
        run: |
          # Verify key routes exist in static build
          ls dist/index.html && echo "✓ Homepage exists"
          ls dist/q/index.html && echo "✓ Questions index exists"
          ls dist/category/index.html && echo "✓ Categories index exists" || true
          ls dist/providers/index.html && echo "✓ Providers index exists" || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # Dependency review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0

  # Secret scanning prevention
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [security, lint, test, build, dependency-review, secret-scan]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Review | ${{ needs.dependency-review.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.security.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.build.result == 'failure' ||
          (github.event_name == 'pull_request' && needs.dependency-review.result == 'failure') ||
          needs.secret-scan.result == 'failure'
        run: exit 1
