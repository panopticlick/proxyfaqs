---
/**
 * Question Detail Page
 *
 * Dynamic SSR page for individual Q&A content with:
 * - Comprehensive SEO (FAQ, Article, Breadcrumb schemas)
 * - Related questions sidebar
 * - Social sharing
 * - Accessibility optimizations
 */

export const prerender = false;

import Base from '../../layouts/Base.astro';
import { getQuestion, getRelatedQuestions, type Question } from '../../lib/supabase';
import { generateFAQSchema, generateBreadcrumbSchema, generateArticleSchema, formatDate, generateMetaDescription } from '../../lib/utils';
import { env } from '../../lib/env';
import { marked } from 'marked';

const { slug } = Astro.params;

const runtimeEnv = (Astro.locals as { runtime?: { env?: Record<string, unknown> } }).runtime?.env;

if (!slug) {
  return Astro.redirect('/404');
}

let question: Question | null = null;
let relatedQuestions: Question[] = [];

try {
  question = await getQuestion(slug, runtimeEnv);
  if (question) {
    relatedQuestions = await getRelatedQuestions(question, 5, runtimeEnv);
  }
} catch (error) {
  console.error('Error fetching question:', error);
}

if (!question) {
  return Astro.redirect('/404');
}

const siteUrl = env.SITE;
const pageUrl = `${siteUrl}/q/${slug}`;

// Generate HTML from markdown if answer_html doesn't exist
const answerHtml = question.answer_html || await marked.parse(question.answer);
const plainAnswer = question.answer.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();

// Generate optimized meta description
const metaDescription = question.meta_description || generateMetaDescription(question.answer);

// Calculate reading time (average 200 words per minute)
const wordCount = plainAnswer.split(/\s+/).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Generate JSON-LD structured data
const jsonLd = [
  generateFAQSchema([{ question: question.question, answer: plainAnswer.slice(0, 500) }]),
  generateBreadcrumbSchema([
    { name: 'Home', url: siteUrl },
    { name: 'Questions', url: `${siteUrl}/q` },
    { name: question.category, url: `${siteUrl}/category/${question.category_slug}` },
    { name: question.question.substring(0, 50), url: pageUrl },
  ]),
  generateArticleSchema({
    title: question.question,
    description: metaDescription,
    url: pageUrl,
    datePublished: question.created_at,
    dateModified: question.updated_at,
  }),
  // QAPage schema for better search appearance
  {
    "@context": "https://schema.org",
    "@type": "QAPage",
    "mainEntity": {
      "@type": "Question",
      "name": question.question,
      "text": question.question,
      "answerCount": 1,
      "dateCreated": question.created_at,
      "author": {
        "@type": "Organization",
        "name": "ProxyFAQs"
      },
      "acceptedAnswer": {
        "@type": "Answer",
        "text": plainAnswer.slice(0, 1000),
        "dateCreated": question.created_at,
        "author": {
          "@type": "Organization",
          "name": "ProxyFAQs"
        }
      }
    }
  }
];

// Generate keywords from category and question
const keywords = [
  question.category?.toLowerCase(),
  'proxy',
  'web scraping',
  ...question.question.toLowerCase().split(' ').filter(w => w.length > 4).slice(0, 5)
].filter(Boolean).join(', ');
---

<Base
  title={question.meta_title || question.question}
  description={metaDescription}
  canonicalUrl={pageUrl}
  jsonLd={jsonLd}
  ogType="article"
  keywords={keywords}
  publishedTime={question.created_at}
  modifiedTime={question.updated_at}
>
  <article class="py-8 md:py-12" itemscope itemtype="https://schema.org/QAPage">
    <div class="container-custom">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <main class="lg:col-span-2">
          <!-- Breadcrumbs -->
          <nav class="mb-6" aria-label="Breadcrumb">
            <ol class="flex flex-wrap items-center gap-2 text-sm text-secondary-500" itemscope itemtype="https://schema.org/BreadcrumbList">
              <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="/" class="hover:text-primary-600" itemprop="item">
                  <span itemprop="name">Home</span>
                </a>
                <meta itemprop="position" content="1" />
              </li>
              <li class="flex items-center gap-2" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
                <a href="/q" class="hover:text-primary-600" itemprop="item">
                  <span itemprop="name">Questions</span>
                </a>
                <meta itemprop="position" content="2" />
              </li>
              {question.category && (
                <li class="flex items-center gap-2" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  <a href={`/category/${question.category_slug}`} class="hover:text-primary-600" itemprop="item">
                    <span itemprop="name">{question.category}</span>
                  </a>
                  <meta itemprop="position" content="3" />
                </li>
              )}
            </ol>
          </nav>

          <!-- Question Card -->
          <div class="card mb-8" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
            <div class="flex items-start gap-4 mb-6">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-xl bg-primary-100 flex items-center justify-center">
                  <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="flex-1">
                <a href={`/category/${question.category_slug}`} class="category-pill mb-2 inline-block">
                  {question.category}
                </a>
                <h1 class="text-2xl md:text-3xl font-bold text-secondary-900 mt-2" itemprop="name">
                  {question.question}
                </h1>
                <div class="flex items-center gap-4 mt-3 text-sm text-secondary-500">
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {readingTime} min read
                  </span>
                  {question.view_count > 0 && (
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      {question.view_count.toLocaleString()} views
                    </span>
                  )}
                </div>
              </div>
            </div>

            <!-- Answer -->
            <div class="prose-custom mt-8" itemprop="acceptedAnswer" itemscope itemtype="https://schema.org/Answer">
              <div itemprop="text" set:html={answerHtml} />
            </div>

            <!-- Meta Info & Social Share -->
            <div class="flex flex-wrap items-center justify-between gap-4 mt-8 pt-6 border-t border-secondary-200">
              <div class="flex flex-wrap items-center gap-4 text-sm text-secondary-500">
                <time datetime={question.updated_at} class="flex items-center gap-1" itemprop="dateModified">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Updated {formatDate(question.updated_at)}
                </time>
                {question.source_url && (
                  <a
                    href={question.source_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-1 text-primary-600 hover:text-primary-700"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    Source
                  </a>
                )}
              </div>

              <!-- Social Share Buttons -->
              <div class="flex items-center gap-2">
                <span class="text-sm text-secondary-500">Share:</span>
                <a
                  href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(question.question)}&url=${encodeURIComponent(pageUrl)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 rounded-lg hover:bg-secondary-100 transition-colors"
                  aria-label="Share on Twitter"
                >
                  <svg class="w-5 h-5 text-secondary-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </a>
                <a
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="p-2 rounded-lg hover:bg-secondary-100 transition-colors"
                  aria-label="Share on LinkedIn"
                >
                  <svg class="w-5 h-5 text-secondary-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                  </svg>
                </a>
                <button
                  class="p-2 rounded-lg hover:bg-secondary-100 transition-colors copy-link-btn"
                  aria-label="Copy link"
                  data-url={pageUrl}
                >
                  <svg class="w-5 h-5 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </main>

        <!-- Sidebar -->
        <aside class="lg:col-span-1">
          <div class="sticky top-24 space-y-6">
            <!-- Related Questions -->
            {relatedQuestions.length > 0 && (
              <div class="card">
                <h2 class="font-semibold text-secondary-900 mb-4">Related Questions</h2>
                <nav aria-label="Related questions">
                  <ul class="space-y-3">
                    {relatedQuestions.map((related) => (
                      <li>
                        <a
                          href={`/q/${related.slug}`}
                          class="block p-3 rounded-lg hover:bg-secondary-50 transition-colors group"
                        >
                          <span class="text-sm text-secondary-700 group-hover:text-primary-600 line-clamp-2">
                            {related.question}
                          </span>
                        </a>
                      </li>
                    ))}
                  </ul>
                </nav>
              </div>
            )}

            <!-- CTA Card -->
            <div class="card bg-gradient-to-br from-primary-50 to-white">
              <h2 class="font-semibold text-secondary-900 mb-2">Need more help?</h2>
              <p class="text-sm text-secondary-600 mb-4">
                Chat with our AI assistant or compare proxy providers.
              </p>
              <div class="space-y-2">
                <a href="/providers" class="btn-primary w-full text-center text-sm">
                  Compare Providers
                </a>
                <a href="/category" class="btn-secondary w-full text-center text-sm">
                  Browse Categories
                </a>
              </div>
            </div>

            <!-- Category Info -->
            {question.category && (
              <div class="card">
                <h2 class="font-semibold text-secondary-900 mb-2">Category</h2>
                <a
                  href={`/category/${question.category_slug}`}
                  class="flex items-center gap-2 text-primary-600 hover:text-primary-700"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                  </svg>
                  {question.category}
                </a>
                <p class="text-sm text-secondary-500 mt-2">
                  Explore more questions in this category
                </p>
              </div>
            )}
          </div>
        </aside>
      </div>
    </div>
  </article>

  <script>
    // Copy link functionality
    document.querySelectorAll('.copy-link-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const url = btn.getAttribute('data-url');
        if (url) {
          try {
            await navigator.clipboard.writeText(url);
            const svg = btn.querySelector('svg');
            if (svg) {
              svg.classList.add('text-green-600');
              setTimeout(() => svg.classList.remove('text-green-600'), 2000);
            }
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });
    });
  </script>
</Base>
