---
/**
 * AI Chat Widget - ProxyFAQs
 *
 * A floating chat widget that provides AI-powered assistance.
 * Uses VectorEngine API with grok-4-fast-non-reasoning model.
 * All API calls go through Cloudflare Workers to protect API keys.
 */

const starterQuestions = [
  'What proxy should I use for Amazon?',
  'Why am I getting blocked?',
  'Residential vs datacenter proxies?',
  'Best proxy for web scraping?',
];
---

<!-- Chat Toggle Button -->
<button
  id="chat-toggle"
  class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-primary-600 text-white shadow-lg hover:bg-primary-700 hover:scale-110 transition-all flex items-center justify-center opacity-0 translate-y-4"
  aria-label="Open chat"
  aria-expanded="false"
>
  <!-- Favicon icon -->
  <svg
    class="w-7 h-7 chat-open-icon"
    viewBox="0 0 32 32"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2.5"></circle>
    <circle cx="16" cy="16" r="6" fill="currentColor"></circle>
    <path
      d="M16 2V8M16 24V30M2 16H8M24 16H30"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"></path>
  </svg>
  <svg class="w-6 h-6 chat-close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
    ></path>
  </svg>
</button>

<!-- Chat notification badge -->
<span
  id="chat-badge"
  class="fixed bottom-[72px] right-6 z-50 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full opacity-0 transition-opacity"
>
  Ask me anything!
</span>

<!-- Chat Window -->
<div
  id="chat-window"
  class="fixed bottom-24 right-6 z-50 w-[360px] max-w-[calc(100vw-48px)] bg-white rounded-2xl shadow-2xl border border-secondary-200 hidden"
>
  <!-- Header -->
  <div
    class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-primary-600 to-primary-700 rounded-t-2xl"
  >
    <svg
      class="w-8 h-8 text-white"
      viewBox="0 0 32 32"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2"></circle>
      <circle cx="16" cy="16" r="6" fill="currentColor"></circle>
    </svg>
    <div class="flex-1">
      <h3 class="text-white font-semibold text-sm">ProxyFAQs Assistant</h3>
      <p class="text-primary-200 text-xs">10+ years of proxy expertise</p>
    </div>
    <button
      id="chat-minimize"
      class="text-white/80 hover:text-white transition-colors p-1"
      aria-label="Minimize chat"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
        ></path>
      </svg>
    </button>
  </div>

  <!-- Messages Container -->
  <div
    id="chat-messages"
    class="h-[320px] overflow-y-auto p-4 space-y-4"
    role="log"
    aria-live="polite"
    aria-relevant="additions"
  >
    <!-- Welcome message -->
    <div class="chat-bubble-bot">
      <p class="text-sm">Hi! I'm your proxy expert assistant. I can help you with:</p>
      <ul class="mt-2 text-sm space-y-1">
        <li>• Choosing the right proxy type</li>
        <li>• Troubleshooting blocks</li>
        <li>• Comparing providers</li>
        <li>• Web scraping best practices</li>
      </ul>
    </div>

    <!-- Starter Questions -->
    <div class="flex flex-wrap gap-2">
      {
        starterQuestions.map((q) => (
          <button
            class="starter-question text-xs px-3 py-1.5 rounded-full bg-secondary-100 text-secondary-700 hover:bg-primary-100 hover:text-primary-700 transition-colors"
            data-question={q}
          >
            {q}
          </button>
        ))
      }
    </div>
  </div>

  <!-- Input Area -->
  <div class="p-4 border-t border-secondary-200">
    <form id="chat-form" class="flex gap-2">
      <input
        type="text"
        id="chat-input"
        placeholder="Ask about proxies..."
        class="flex-1 px-4 py-2 rounded-lg border border-secondary-300 text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors"
        autocomplete="off"
      />
      <button
        type="submit"
        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        aria-label="Send message"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
      </button>
    </form>
    <p class="mt-2 text-xs text-secondary-500 text-center">
      Powered by AI • <a href="/providers" class="text-primary-600 hover:underline"
        >Compare providers</a
      >
    </p>
  </div>
</div>

<script>
  // Chat widget logic
  const chatToggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatMinimize = document.getElementById('chat-minimize');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const chatMessages = document.getElementById('chat-messages');
  const chatBadge = document.getElementById('chat-badge');
  const openIcon = chatToggle?.querySelector('.chat-open-icon');
  const closeIcon = chatToggle?.querySelector('.chat-close-icon');
  const starterButtons = document.querySelectorAll('.starter-question');

  let isOpen = false;
  let sessionId = '';
  let hasShownBadge = false;

  // Generate session ID
  function generateSessionId(): string {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
  }

  // Show chat button after 15 seconds with animation
  setTimeout(() => {
    if (chatToggle) {
      chatToggle.classList.remove('opacity-0', 'translate-y-4');
      chatToggle.classList.add('animate-bounce-subtle');
    }
    // Show badge after 3 more seconds
    setTimeout(() => {
      if (!hasShownBadge && chatBadge && !isOpen) {
        chatBadge.classList.remove('opacity-0');
        hasShownBadge = true;
        // Hide badge after 5 seconds
        setTimeout(() => {
          chatBadge?.classList.add('opacity-0');
        }, 5000);
      }
    }, 3000);
  }, 15000);

  // Toggle chat window
  function toggleChat() {
    isOpen = !isOpen;
    chatWindow?.classList.toggle('hidden', !isOpen);
    openIcon?.classList.toggle('hidden', isOpen);
    closeIcon?.classList.toggle('hidden', !isOpen);
    chatToggle?.setAttribute('aria-expanded', isOpen.toString());
    chatBadge?.classList.add('opacity-0');

    if (isOpen && !sessionId) {
      sessionId = generateSessionId();
    }

    if (isOpen) {
      chatInput?.focus();
    }
  }

  chatToggle?.addEventListener('click', toggleChat);
  chatMinimize?.addEventListener('click', toggleChat);

  // Starter questions
  starterButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const question = btn.getAttribute('data-question');
      if (question && chatInput) {
        chatInput.value = question;
        sendMessage(question);
      }
    });
  });

  // Send message
  async function sendMessage(message: string) {
    if (!message.trim() || !chatMessages) return;

    // Add user message
    const userBubble = document.createElement('div');
    userBubble.className = 'chat-bubble-user';
    userBubble.innerHTML = `<p class="text-sm">${escapeHtml(message)}</p>`;
    chatMessages.appendChild(userBubble);

    // Hide starter questions after first message
    const starters = chatMessages.querySelector('.flex.flex-wrap');
    if (starters) starters.remove();

    // Clear input
    if (chatInput) chatInput.value = '';

    // Add loading indicator
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'chat-bubble-bot loading-bubble';
    loadingBubble.innerHTML = `
      <div class="flex gap-1">
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
      </div>
    `;
    chatMessages.appendChild(loadingBubble);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatMessages.setAttribute('aria-busy', 'true');

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          sessionId,
          pageContext: window.location.pathname,
        }),
      });

      const data = await response.json();

      // Remove loading indicator
      loadingBubble.remove();
      chatMessages.setAttribute('aria-busy', 'false');

      // Add bot response
      const botBubble = document.createElement('div');
      botBubble.className = 'chat-bubble-bot';
      let responseContent = formatResponse(data.response || '');
      // Add inline disclosure if affiliate links detected
      if (
        hasAffiliateLinks(data.response || '') &&
        !responseContent.includes('Affiliate Disclosure')
      ) {
        responseContent += `<div class="mt-3 pt-3 border-t border-secondary-200 text-xs text-secondary-500 italic">
          <a href="/privacy#affiliate-disclosure" class="text-primary-600 hover:underline">Affiliate Disclosure</a>: Some links may earn us a commission.
        </div>`;
      }
      botBubble.innerHTML = `<div class="text-sm prose-sm">${responseContent}</div>`;
      chatMessages.appendChild(botBubble);
    } catch (error) {
      loadingBubble.remove();
      chatMessages.setAttribute('aria-busy', 'false');
      const errorBubble = document.createElement('div');
      errorBubble.className = 'chat-bubble-bot';
      errorBubble.innerHTML = `<p class="text-sm text-red-600">Sorry, something went wrong. Please try again.</p>`;
      chatMessages.appendChild(errorBubble);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Form submit
  chatForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    if (chatInput) {
      sendMessage(chatInput.value);
    }
  });

  // Helper functions
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatResponse(text: string): string {
    const escaped = escapeHtml(text);
    const codeBlocks: string[] = [];
    const withPlaceholders = escaped.replace(
      /```(?:[a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g,
      (_match, code) => {
        const index = codeBlocks.length;
        codeBlocks.push(code);
        return `__CODE_BLOCK_${index}__`;
      }
    );

    let formatted = withPlaceholders
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');

    codeBlocks.forEach((code, index) => {
      const block = `<pre><code>${code}</code></pre>`;
      formatted = formatted.replace(`__CODE_BLOCK_${index}__`, block);
    });

    return formatted;
  }

  // Check if response contains affiliate links
  function hasAffiliateLinks(text: string): boolean {
    const affiliateDomains = [
      'brightdata.com',
      'luminati.com',
      'soax.com',
      'smartproxy.com',
      'proxy-seller.com',
      'webshare.io',
      'rayobyte.com',
      'oxylabs.io',
      'thesocialproxy.com',
      'proxy-cheap.com',
      'get.brightdata.com',
      'smartproxy.pxf.io',
    ];
    const lowerText = text.toLowerCase();
    return (
      affiliateDomains.some((domain) => lowerText.includes(domain)) ||
      /affiliate|commission|referral/i.test(text)
    );
  }
</script>

<style>
  /* Chat bubble animations */
  .chat-bubble-bot,
  .chat-bubble-user {
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
