---
/**
 * AI Chat Widget - ProxyFAQs
 *
 * Production-grade floating chat widget with:
 * - Multi-provider AI support (OpenRouter + VectorEngine)
 * - Rate limiting awareness
 * - Accessibility (ARIA, keyboard navigation)
 * - Mobile-optimized responsive design
 * - Message history persistence
 */

const starterQuestions = [
  'What proxy should I use for Amazon?',
  'Why am I getting blocked?',
  'Residential vs datacenter proxies?',
  'Best proxy for web scraping?',
];
---

<!-- Chat Toggle Button -->
<button
  id="chat-toggle"
  class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-primary-600 text-white shadow-lg hover:bg-primary-700 hover:scale-110 transition-all flex items-center justify-center opacity-0 translate-y-4 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
  aria-label="Open chat assistant"
  aria-expanded="false"
  aria-controls="chat-window"
  aria-haspopup="dialog"
>
  <!-- Favicon icon -->
  <svg class="w-7 h-7 chat-open-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2.5"/>
    <circle cx="16" cy="16" r="6" fill="currentColor"/>
    <path d="M16 2V8M16 24V30M2 16H8M24 16H30" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <svg class="w-6 h-6 chat-close-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>

<!-- Chat notification badge -->
<span id="chat-badge" class="fixed bottom-[72px] right-6 z-50 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full opacity-0 transition-opacity pointer-events-none" aria-hidden="true">
  Ask me anything!
</span>

<!-- Chat Window -->
<div
  id="chat-window"
  class="fixed bottom-24 right-6 z-50 w-[360px] max-w-[calc(100vw-48px)] bg-white rounded-2xl shadow-2xl border border-secondary-200 hidden"
  role="dialog"
  aria-labelledby="chat-title"
  aria-describedby="chat-description"
>
  <!-- Header -->
  <div class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-primary-600 to-primary-700 rounded-t-2xl">
    <svg class="w-8 h-8 text-white" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2"/>
      <circle cx="16" cy="16" r="6" fill="currentColor"/>
    </svg>
    <div class="flex-1">
      <h3 id="chat-title" class="text-white font-semibold text-sm">ProxyFAQs Assistant</h3>
      <p id="chat-description" class="text-primary-200 text-xs">10+ years of proxy expertise</p>
    </div>
    <button id="chat-minimize" class="text-white/80 hover:text-white transition-colors p-1 focus:outline-none focus:ring-2 focus:ring-white/50 rounded" aria-label="Minimize chat">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
  </div>

  <!-- Messages Container -->
  <div id="chat-messages" class="h-[320px] overflow-y-auto p-4 space-y-4" role="log" aria-live="polite" aria-label="Chat messages">
    <!-- Welcome message -->
    <div class="chat-bubble-bot">
      <p class="text-sm">Hi! I'm your proxy expert assistant. I can help you with:</p>
      <ul class="mt-2 text-sm space-y-1">
        <li>• Choosing the right proxy type</li>
        <li>• Troubleshooting blocks</li>
        <li>• Comparing providers</li>
        <li>• Web scraping best practices</li>
      </ul>
    </div>

    <!-- Starter Questions -->
    <div class="starter-questions flex flex-wrap gap-2">
      {starterQuestions.map((q) => (
        <button
          class="starter-question text-xs px-3 py-1.5 rounded-full bg-secondary-100 text-secondary-700 hover:bg-primary-100 hover:text-primary-700 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500"
          data-question={q}
          type="button"
        >
          {q}
        </button>
      ))}
    </div>
  </div>

  <!-- Input Area -->
  <div class="p-4 border-t border-secondary-200">
    <form id="chat-form" class="flex gap-2">
      <input
        type="text"
        id="chat-input"
        placeholder="Ask about proxies..."
        class="flex-1 px-4 py-2 rounded-lg border border-secondary-300 text-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-200 focus:outline-none transition-colors"
        autocomplete="off"
        maxlength="1000"
        aria-label="Type your message"
      />
      <button
        type="submit"
        id="chat-submit"
        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
        aria-label="Send message"
      >
        <svg class="w-5 h-5 send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        <svg class="w-5 h-5 loading-icon hidden animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </button>
    </form>
    <div class="flex items-center justify-between mt-2">
      <span id="chat-status" class="text-xs text-secondary-400"></span>
      <p class="text-xs text-secondary-500">
        <a href="/providers" class="text-primary-600 hover:underline">Compare providers</a>
      </p>
    </div>
  </div>
</div>

<script>
  // Chat widget logic with enhanced features
  const chatToggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatMinimize = document.getElementById('chat-minimize');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const chatMessages = document.getElementById('chat-messages');
  const chatBadge = document.getElementById('chat-badge');
  const chatSubmit = document.getElementById('chat-submit');
  const chatStatus = document.getElementById('chat-status');
  const openIcon = chatToggle?.querySelector('.chat-open-icon');
  const closeIcon = chatToggle?.querySelector('.chat-close-icon');
  const sendIcon = chatSubmit?.querySelector('.send-icon');
  const loadingIcon = chatSubmit?.querySelector('.loading-icon');
  const starterButtons = document.querySelectorAll('.starter-question');

  let isOpen = false;
  let isLoading = false;
  let sessionId = '';
  let hasShownBadge = false;
  let messageCount = 0;

  // Generate session ID
  function generateSessionId(): string {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
  }

  // Show chat button after delay with animation
  setTimeout(() => {
    if (chatToggle) {
      chatToggle.classList.remove('opacity-0', 'translate-y-4');
      chatToggle.classList.add('animate-bounce-subtle');
    }
    // Show badge after 3 more seconds
    setTimeout(() => {
      if (!hasShownBadge && chatBadge && !isOpen) {
        chatBadge.classList.remove('opacity-0');
        hasShownBadge = true;
        // Hide badge after 5 seconds
        setTimeout(() => {
          chatBadge?.classList.add('opacity-0');
        }, 5000);
      }
    }, 3000);
  }, 10000);

  // Toggle chat window
  function toggleChat() {
    isOpen = !isOpen;
    chatWindow?.classList.toggle('hidden', !isOpen);
    openIcon?.classList.toggle('hidden', isOpen);
    closeIcon?.classList.toggle('hidden', !isOpen);
    chatToggle?.setAttribute('aria-expanded', isOpen.toString());
    chatBadge?.classList.add('opacity-0');

    if (isOpen && !sessionId) {
      sessionId = generateSessionId();
    }

    if (isOpen) {
      chatInput?.focus();
    }
  }

  chatToggle?.addEventListener('click', toggleChat);
  chatMinimize?.addEventListener('click', toggleChat);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Escape to close chat
    if (e.key === 'Escape' && isOpen) {
      toggleChat();
    }
  });

  // Starter questions
  starterButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const question = btn.getAttribute('data-question');
      if (question && chatInput && !isLoading) {
        chatInput.value = question;
        sendMessage(question);
      }
    });
  });

  // Set loading state
  function setLoading(loading: boolean) {
    isLoading = loading;
    if (chatSubmit) {
      chatSubmit.toggleAttribute('disabled', loading);
    }
    if (chatInput) {
      chatInput.toggleAttribute('disabled', loading);
    }
    sendIcon?.classList.toggle('hidden', loading);
    loadingIcon?.classList.toggle('hidden', !loading);
  }

  // Update status message
  function setStatus(message: string, isError = false) {
    if (chatStatus) {
      chatStatus.textContent = message;
      chatStatus.classList.toggle('text-red-500', isError);
      chatStatus.classList.toggle('text-secondary-400', !isError);
    }
  }

  // Send message
  async function sendMessage(message: string) {
    if (!message.trim() || !chatMessages || isLoading) return;

    setLoading(true);
    setStatus('');
    messageCount++;

    // Add user message
    const userBubble = document.createElement('div');
    userBubble.className = 'chat-bubble-user';
    userBubble.innerHTML = `<p class="text-sm">${escapeHtml(message)}</p>`;
    chatMessages.appendChild(userBubble);

    // Hide starter questions after first message
    const starters = chatMessages.querySelector('.starter-questions');
    if (starters) starters.remove();

    // Clear input
    if (chatInput) chatInput.value = '';

    // Add loading indicator
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'chat-bubble-bot loading-bubble';
    loadingBubble.innerHTML = `
      <div class="flex gap-1">
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
      </div>
    `;
    chatMessages.appendChild(loadingBubble);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatMessages.setAttribute('aria-busy', 'true');

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          sessionId,
          pageContext: document.title + ' - ' + window.location.pathname,
        }),
      });

      // Remove loading indicator
      loadingBubble.remove();
      chatMessages.setAttribute('aria-busy', 'false');

      // Handle rate limiting
      if (response.status === 429) {
        const data = await response.json();
        const retryAfter = data.retryAfter || 60;
        setStatus(`Rate limited. Try again in ${retryAfter}s`, true);

        const errorBubble = document.createElement('div');
        errorBubble.className = 'chat-bubble-bot';
        errorBubble.innerHTML = `<p class="text-sm text-amber-600">You've sent too many messages. Please wait ${retryAfter} seconds before trying again.</p>`;
        chatMessages.appendChild(errorBubble);
        setLoading(false);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return;
      }

      if (!response.ok) {
        throw new Error('Chat request failed');
      }

      const data = await response.json();

      // Add bot response
      const botBubble = document.createElement('div');
      botBubble.className = 'chat-bubble-bot';
      const reply = data.response || 'Sorry, I could not generate a response.';
      botBubble.innerHTML = `<div class="text-sm prose-sm">${formatResponse(reply)}</div>`;
      chatMessages.appendChild(botBubble);

      // Show remaining requests if available
      const remaining = response.headers.get('X-RateLimit-Remaining');
      if (remaining && parseInt(remaining) < 5) {
        setStatus(`${remaining} messages remaining`);
      }
    } catch (error) {
      loadingBubble.remove();
      chatMessages.setAttribute('aria-busy', 'false');
      const errorBubble = document.createElement('div');
      errorBubble.className = 'chat-bubble-bot';
      errorBubble.innerHTML = `<p class="text-sm text-red-600">Sorry, something went wrong. Please try again.</p>`;
      chatMessages.appendChild(errorBubble);
      setStatus('Connection error', true);
    }

    setLoading(false);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatInput?.focus();
  }

  // Form submit
  chatForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    if (chatInput && !isLoading) {
      sendMessage(chatInput.value);
    }
  });

  // Helper functions
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatResponse(text: string): string {
    // Escape first, then apply minimal formatting
    const safe = escapeHtml(text);
    return safe
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code class="bg-secondary-100 px-1 rounded text-xs">$1</code>')
      .replace(/\n\n/g, '</p><p class="mt-2">')
      .replace(/\n/g, '<br>');

    codeBlocks.forEach((code, index) => {
      const block = `<pre><code>${code}</code></pre>`;
      formatted = formatted.replace(`__CODE_BLOCK_${index}__`, block);
    });

    return formatted;
  }

  // Check if response contains affiliate links
  function hasAffiliateLinks(text: string): boolean {
    const affiliateDomains = [
      'brightdata.com',
      'luminati.com',
      'soax.com',
      'smartproxy.com',
      'proxy-seller.com',
      'webshare.io',
      'rayobyte.com',
      'oxylabs.io',
      'thesocialproxy.com',
      'proxy-cheap.com',
      'get.brightdata.com',
      'smartproxy.pxf.io',
    ];
    const lowerText = text.toLowerCase();
    return (
      affiliateDomains.some((domain) => lowerText.includes(domain)) ||
      /affiliate|commission|referral/i.test(text)
    );
  }
</script>

<style>
  /* Chat bubble animations */
  .chat-bubble-bot,
  .chat-bubble-user {
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
