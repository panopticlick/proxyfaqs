---
/**
 * Error Boundary Component
 *
 * Catches client-side JavaScript errors and displays a fallback UI.
 * Also reports errors to telemetry for monitoring.
 */

interface Props {
  title?: string;
  message?: string;
  showRetry?: boolean;
}

const {
  title = 'Something went wrong',
  message = 'An unexpected error occurred. Please try refreshing the page.',
  showRetry = true,
} = Astro.props;
---

<div id="error-boundary" class="error-boundary hidden">
  <div class="error-container">
    <div class="error-icon">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="48"
        height="48"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <h2 class="error-title">{title}</h2>
    <p class="error-message">{message}</p>
    <div class="error-actions">
      {
        showRetry && (
          <button id="error-retry" class="btn-primary">
            Try Again
          </button>
        )
      }
      <button id="error-reload" class="btn-secondary">Reload Page</button>
    </div>
    <details class="error-details">
      <summary>Technical details</summary>
      <pre id="error-stack"></pre>
    </details>
  </div>
</div>

<style>
  .error-boundary {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-background, #fff);
    padding: 1rem;
  }

  .error-boundary.hidden {
    display: none;
  }

  .error-container {
    max-width: 500px;
    text-align: center;
  }

  .error-icon {
    color: var(--color-error, #dc2626);
    margin-bottom: 1rem;
  }

  .error-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-text, #111);
  }

  .error-message {
    color: var(--color-text-secondary, #666);
    margin-bottom: 1.5rem;
    line-height: 1.5;
  }

  .error-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.625rem 1.25rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    border: none;
  }

  .btn-primary {
    background: var(--color-primary, #2563eb);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark, #1d4ed8);
  }

  .btn-secondary {
    background: var(--color-background-secondary, #f3f4f6);
    color: var(--color-text, #111);
  }

  .btn-secondary:hover {
    background: var(--color-background-tertiary, #e5e7eb);
  }

  .error-details {
    margin-top: 1rem;
    text-align: left;
  }

  .error-details summary {
    cursor: pointer;
    color: var(--color-text-secondary, #666);
    font-size: 0.875rem;
    user-select: none;
  }

  .error-details pre {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: var(--color-background-secondary, #f3f4f6);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    overflow: auto;
    max-height: 200px;
  }
</style>

<script define:vars={{ title, message }}>
  // Client-side error handling
  let hasError = false;

  // Report error to server
  function reportError(error, context) {
    const errorData = {
      name: error.name,
      message: error.message,
      stack: error.stack,
      context: {
        ...context,
        userAgent: navigator.userAgent,
        url: window.location.href,
        timestamp: new Date().toISOString(),
      },
    };

    // Send to monitoring endpoint (non-blocking)
    fetch('/api/monitoring/error', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(errorData),
      keepalive: true,
    }).catch(() => {
      // Silently fail if error reporting fails
    });

    // Log to console
    console.error('[Error Boundary]', error);
  }

  // Show error UI
  function showError(error) {
    if (hasError) return;
    hasError = true;

    const boundary = document.getElementById('error-boundary');
    const stackEl = document.getElementById('error-stack');

    if (boundary) {
      boundary.classList.remove('hidden');
    }

    if (stackEl && error.stack) {
      stackEl.textContent = error.stack;
    }

    // Report the error
    reportError(error, { title, message });
  }

  // Global error handler
  window.addEventListener('error', (event) => {
    if (event.error) {
      showError(event.error);
    }
  });

  // Unhandled promise rejection handler
  window.addEventListener('unhandledrejection', (event) => {
    const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));
    showError(error);
  });

  // Retry button handler
  const retryBtn = document.getElementById('error-retry');
  if (retryBtn) {
    retryBtn.addEventListener('click', () => {
      const boundary = document.getElementById('error-boundary');
      if (boundary) {
        boundary.classList.add('hidden');
      }
      hasError = false;
      // Optionally retry the failed operation
    });
  }

  // Reload button handler
  const reloadBtn = document.getElementById('error-reload');
  if (reloadBtn) {
    reloadBtn.addEventListener('click', () => {
      window.location.reload();
    });
  }

  // Expose error reporting globally for manual use
  window.reportError = reportError;
</script>
